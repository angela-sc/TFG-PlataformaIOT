@page "/estacionbase"

@using Libreria.Entidades
@using Syncfusion.Blazor.Maps


<!-- Page Content -->
    <div class="container">
        <!-- Jumbotron Header -->
        <header class="jumbotron">
            <h3>Estación @nombreEstacionBase </h3>
            <!--<p class="lead">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ipsa, ipsam, eligendi, in quo sunt possimus non incidunt odit vero aliquid similique quaerat nam nobis illo aspernatur vitae fugiat numquam repellat.</p>-->
            <!--<a href="#" class="btn btn-primary btn-lg">Call to action!</a>-->
            <div class="map">
                <SfMaps @ref="mapa">
                    @* To zoom and pan *@
                    <MapsZoomSettings Enable="true"
                                      Toolbars='new string[]{"Zoom", "ZoomIn", "ZoomOut", "Reset" }'
                                      ZoomFactor="4" MaxZoom="20">
                    </MapsZoomSettings>

                    <MapsLayers>
                        <MapsLayer LayerType="ShapeLayerType.OSM">
                            @* Add marker *@
                            <MapsMarkerSettings>
                                <MapsMarker Visible="true"
                                            Height="25"
                                            Width="25"
                                            DataSource="MarkerDataSource">
                                </MapsMarker>
                            </MapsMarkerSettings>

                        </MapsLayer>
                    </MapsLayers>
                </SfMaps>

            </div>
        </header>

        <!-- Page Features -->
        <div class="row ">
            @foreach (EntidadSensorResultado sensor in listaSensores)
            {
                <div class="col-lg-4 col-md-7 mb-5">
                    <div class="card h-100">
                        <div class="card-body">
                            <h4 class="card-title"><span class="oi oi-rss" aria-hidden="true"></span>   @sensor.NombreSensor</h4>
                            <p>Última actualización: @sensor.Fecha</p>
                            <p>Temperatura: @sensor.Temperatura ºC</p>
                            <p>Humedad: @sensor.Humedad %</p>
                            <a href="/data" class="btn btn-primary">Ir al sensor</a>
                        </div>
                    </div>
                </div>
            }
        </div>
        <!-- /.row -->

    </div>
<!-- /.container -->

@code {

    private string nombreEstacionBase = "EB01";
    private IEnumerable<EntidadSensorResultado> listaSensores = new List<EntidadSensorResultado>();

    private Servicios.ServicioEstacionBase servicio = new Servicios.ServicioEstacionBase("Data Source = (localdb)\\MSSQLLocalDB; Initial Catalog = plataformadb; Integrated Security = true", null);


    //public IEnumerable<EntidadMarcadorMapa> MarkerDataSource = new List<EntidadMarcadorMapa>();
    public List<MapMarkerDataSource> MarkerDataSource = new List<MapMarkerDataSource>();
    SfMaps mapa;



    protected override async Task OnInitializedAsync()
    {
        listaSensores = await servicio.ObtenerSensores(nombreEstacionBase);

        foreach(EntidadSensorResultado sensor in listaSensores)
        {
            MarkerDataSource.Add(new MapMarkerDataSource { latitude = Convert.ToDouble(sensor.Latitud), longitude = Convert.ToDouble(sensor.Longitud), name = sensor.NombreSensor });
        }

        mapa.Refresh(); // Refrescar mapa
    }

    public class MapMarkerDataSource
    {
        public string name;
        public double latitude;
        public double longitude;
    }

    //public List<MapMarkerDataSource> MarkerDataSource = new List<MapMarkerDataSource>();
    //public List<MapMarkerDataSource> MarkerDataSource = new List<MapMarkerDataSource> {
    //    new MapMarkerDataSource{ latitude= 38.14261488138473, longitude= -0.7653415203094482, name= "Alejandro" },
    //    new MapMarkerDataSource{ latitude= 38.13929118949828, longitude= -0.7670044898986816, name= "Angela" }
    //};

}